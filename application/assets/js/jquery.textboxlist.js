(function(d){TextboxList=function(i,u){var x,q,D,v,o=false,l=[],E,g={};var j=d.extend(true,{prefix:"textboxlist",max:null,unique:false,uniqueInsensitive:true,endEditableBit:true,startEditableBit:true,hideEditableBits:true,inBetweenEditableBits:true,keys:{previous:37,next:39},bitsOptions:{editable:{},box:{}},plugins:{},filter:function(H){return d.trim(H.replace(/\s+/g," ")).replace(/,/g,"")},encode:function(H){return H?H.join(","):""},decode:function(H){return H?H.split(","):[]}},u);i=d(i);var t=this;var A=function(){x=i.css("display","none").attr("autocomplete","off").focus(h);q=d('<div class="'+j.prefix+'" />').insertAfter(i).click(function(I){if((I.target==D.get(0)||I.target==q.get(0))&&(!o||v.toElement().get(0)!=D.find(":last-child").get(0))){h()}});D=d('<ul class="'+j.prefix+'-bits" />').appendTo(q);for(var H in j.plugins){m(H,j.plugins[H])}C()};var m=function(I,H){t.plugins[I]=new TextboxList[c(b(I))](t,H)};var C=function(){if(j.endEditableBit){p("editable",null,{tabIndex:x.tabIndex}).inject(D)}w("bitAdd",n,true);w("bitRemove",n,true);d(document).click(function(I){if(!o){return}if(I.target.className.indexOf(j.prefix)!=-1){if(I.target==d(q).get(0)){return}var H=d(I.target).parents("div."+j.prefix);if(H.get(0)==q.get(0)){return}}y()}).keydown(function(J){if(!o||!v){return}var M=v.is("editable")?v.getCaret():null;var L=v.getValue()[1];var H=!!d.map(["shift","alt","meta","ctrl"],function(N){return J[N]}).length;var K=H||(v.is("editable")&&v.isSelected());var I=function(){J.stopPropagation();J.preventDefault()};switch(J.which){case 8:if(v.is("box")){I();return v.remove()}case j.keys.previous:if(v.is("box")||((M==0||!L.length)&&!K)){I();k("prev")}break;case 46:if(v.is("box")){I();return v.remove()}case j.keys.next:if(v.is("box")||(M==L.length&&!K)){I();k("next")}}});B(j.decode(x.val()))};var p=function(H,J,I){if(H=="box"){if(!J[0]&&!J[1]){return false}if(a(j.max)&&D.getChildren("."+j.prefix+"-bit-box").length+1>j.max){return false}if(j.unique&&d.inArray(r(J),l)!=-1){return false}}return new TextboxListBit(H,J,t,d.extend(true,j.bitsOptions[H],I))};var r=function(H){return a(H[0])?H[0]:(j.uniqueInsensitive?H[1].toLowerCase():H[1])};var s=function(J,L,I,K){var H=p("box",[L,J,I]);if(H){if(!K||!K.length){K=D.find("."+j.prefix+"-bit-box").filter(":last")}H.inject(K.length?K:D,K.length?"after":"top")}return t};var k=function(I,K){var J=F(K&&d(K).length?K:v).toElement();var H=F(J[I]());if(H){H.focus()}return t};var h=function(){var H=D.children().filter(":last");if(H){F(H).focus()}return t};var y=function(){if(!o){return t}if(v){v.blur()}o=false;return G("blur")};var F=function(H){return H.jquery?d(H).data("textboxlist:bit"):H};var f=function(){return d.grep(d.map(D.children(),function(I){var J=F(d(I));if(J.is("editable")){return null}var H=J.getValue();return(a(H[0])?H[0]:j.filter(H[1]))||null}),function(H){return H!=undefined})};var B=function(H){if(!H){return}d.each(H,function(J,I){if(I){s.apply(t,d.isArray(I)?[I[1],I[0],I[2]]:[I])}})};var n=function(){x.val(j.encode(f()))};var w=function(I,H){if(g[I]==undefined){g[I]=[]}var J=false;d.each(g[I],function(K){if(K===H){J=true;return}});if(!J){g[I].push(H)}return t};var G=function(J,I,H){if(!g||!g[J]){return t}d.each(g[J],function(K,L){(function(){I=(I!=undefined)?e(I):Array.prototype.slice.call(arguments);var M=function(){return L.apply(t||null,I)};if(H){return setTimeout(M,H)}return M()})()});return t};var z=function(J,I){if(g[J]){for(var H=g[J].length;H--;H){if(g[J][H]===I){g[J].splice(H,1)}}}return t};this.onFocus=function(H){if(v){v.blur()}clearTimeout(E);v=H;q.addClass(j.prefix+"-focus");if(!o){o=true;G("focus",H)}};this.onAdd=function(K){if(j.unique&&K.is("box")){l.push(r(K.getValue()))}if(K.is("box")){var I=F(K.toElement().prev());if((I&&I.is("box")&&j.inBetweenEditableBits)||(!I&&j.startEditableBit)){var J=I&&I.toElement().length?I.toElement():false;var H=p("editable").inject(J||D,J?"after":"top");if(j.hideEditableBits){H.hide()}}}};this.onRemove=function(J){if(!o){return}if(j.unique&&J.is("box")){var H=d.inArray(r(J.getValue()),l);if(H!=-1){l=l.splice(H+1,1)}}var I=F(J.toElement().prev());if(I&&I.is("editable")){I.remove()}k("next",J)};this.onBlur=function(I,H){v=null;q.removeClass(j.prefix+"-focus");E=setTimeout(y,H?0:200)};this.setOptions=function(H){j=d.extend(true,j,H)};this.getOptions=function(){return j};this.getContainer=function(){return q};this.addEvent=w;this.removeEvent=z;this.fireEvent=G;this.create=p;this.add=s;this.getValues=f;this.plugins=[];A()};TextboxListBit=function(h,r,y,q){var f,l,t,i,m,v,j=false,B=b(h);var g=d.extend(true,h=="box"?{deleteButton:true}:{tabIndex:null,growing:true,growingOptions:{},stopEnter:true,addOnBlur:false,addKeys:13},q);this.type=h;this.value=r;var n=this;var u=function(){t=y.getOptions().prefix+"-bit";i=t+"-"+h;l=d("<li />").addClass(t).addClass(i).data("textboxlist:bit",n).hover(function(){l.addClass(t+"-hover").addClass(i+"-hover")},function(){l.removeClass(t+"-hover").removeClass(i+"-hover")});if(h=="box"){l.html(a(n.value[2])?n.value[2]:n.value[1]).click(o);if(g.deleteButton){l.addClass(i+"-deletable");m=d('<a href="#" class="'+i+'-deletebutton" />').click(A).appendTo(l)}l.children().click(function(C){C.stopPropagation();C.preventDefault()})}else{f=d('<input type="text" class="'+i+'-input" autocomplete="off" />').val(n.value?n.value[1]:"").appendTo(l);if(a(g.tabIndex)){f.tabIndex=g.tabIndex}if(g.growing){new GrowingInput(f,g.growingOptions)}f.focus(function(){o(true)}).blur(function(){s(true);if(g.addOnBlur){w()}});if(g.addKeys||g.stopEnter){f.keydown(function(D){if(!j){return}var C=function(){D.stopPropagation();D.preventDefault()};if(g.stopEnter&&D.which===13){C()}if(d.inArray(D.which,e(g.addKeys))!=-1){C();w()}})}}};var p=function(D,C){switch(C||"bottom"){case"top":l.prependTo(D);break;case"bottom":l.appendTo(D);break;case"before":l.insertBefore(D);break;case"after":l.insertAfter(D);break}y.onAdd(n);return x("add")};var o=function(C){if(j){return n}z();j=true;y.onFocus(n);l.addClass(t+"-focus").addClass(t+"-"+h+"-focus");x("focus");if(h=="editable"&&!C){f.focus()}return n};var s=function(C){if(!j){return n}j=false;y.onBlur(n);l.removeClass(t+"-focus").removeClass(t+"-"+h+"-focus");x("blur");if(h=="editable"){if(!C){f.blur()}if(v&&!f.val().length){k()}}return n};var A=function(){s();y.onRemove(n);l.remove();return x("remove")};var z=function(){l.css("display","block");return n};var k=function(){l.css("display","none");v=true;return n};var x=function(C){C=b(C);y.fireEvent("bit"+C,n).fireEvent("bit"+B+C,n);return n};this.is=function(C){return h==C};this.setValue=function(C){if(h=="editable"){f.val(a(C[0])?C[0]:C[1]);if(g.growing){f.data("growing").resize()}}else{r=C}return n};this.getValue=function(){return h=="editable"?[null,f.val(),null]:r};if(h=="editable"){this.getCaret=function(){var C=f.get(0);if(C.createTextRange){var D=document.selection.createRange().duplicate();D.moveEnd("character",C.value.length);if(D.text===""){return C.value.length}return C.value.lastIndexOf(D.text)}else{return C.selectionStart}};this.getCaretEnd=function(){var C=f.get(0);if(C.createTextRange){var D=document.selection.createRange().duplicate();D.moveStart("character",-C.value.length);return D.text.length}else{return C.selectionEnd}};this.isSelected=function(){return j&&(n.getCaret()!==n.getCaretEnd())};var w=function(){var D=n.getValue();var C=y.create("box",D);if(C){C.inject(l,"before");n.setValue([null,"",null]);return C}return null};this.toBox=w}this.toElement=function(){return l};this.focus=o;this.blur=s;this.remove=A;this.inject=p;this.show=z;this.hide=k;this.fireBitEvent=x;u()};var a=function(f){return !!(f||f===0)};var e=function(f){return(Object.prototype.toString.call(f)==="[object Array]")?f:[f]};var c=function(f){return f.replace(/-\D/g,function(g){return g.charAt(1).toUpperCase()})};var b=function(f){return f.replace(/\b[a-z]/g,function(g){return g.toUpperCase()})}})(jQuery);